<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Performance Gotchas · MendelImpute</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">MendelImpute</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../Phasing_and_Imputation/">Phasing and Imputation</a></li><li class="is-active"><a class="tocitem" href>Performance Gotchas</a><ul class="internal"><li><a class="tocitem" href="#First-time-performance"><span>First time performance</span></a></li><li><a class="tocitem" href="#Run-MendelImpute-in-parallel"><span>Run MendelImpute in parallel</span></a></li><li><a class="tocitem" href="#Compressing-haplotype-panels-is-slow"><span>Compressing haplotype panels is slow</span></a></li><li><a class="tocitem" href="#max_d-too-high-(or-too-low)"><span><code>max_d</code> too high (or too low)</span></a></li><li><a class="tocitem" href="#Do-you-have-enough-memory-(RAM)?"><span>Do you have enough memory (RAM)?</span></a></li></ul></li><li><a class="tocitem" href="../painting/">Estimating ancestry</a></li><li><a class="tocitem" href="../ultra+compress/">Ultra compression</a></li><li><a class="tocitem" href="../script/">Run as script</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Performance Gotchas</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Performance Gotchas</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/OpenMendel/MendelImpute.jl/blob/master/docs/src/man/performance.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Performance-gotchas"><a class="docs-heading-anchor" href="#Performance-gotchas">Performance gotchas</a><a id="Performance-gotchas-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-gotchas" title="Permalink"></a></h1><h2 id="First-time-performance"><a class="docs-heading-anchor" href="#First-time-performance">First time performance</a><a id="First-time-performance-1"></a><a class="docs-heading-anchor-permalink" href="#First-time-performance" title="Permalink"></a></h2><p>In a fresh Julia session, the first time any function gets called will take a long time because the code has to be compiled on the spot. For instance, compare</p><pre><code class="language-julia hljs">@time using MendelImpute</code></pre><pre><code class="nohighlight hljs">  6.958706 seconds (16.72 M allocations: 1.148 GiB, 5.00% gc time)</code></pre><pre><code class="language-julia hljs">@time using MendelImpute</code></pre><pre><code class="nohighlight hljs">  0.022658 seconds (32.81 k allocations: 1.886 MiB, 99.49% compilation time)</code></pre><p>The first call was 350 times slower than the second time! Fortunately, for large problems, compilation time becomes negligible.</p><h2 id="Run-MendelImpute-in-parallel"><a class="docs-heading-anchor" href="#Run-MendelImpute-in-parallel">Run MendelImpute in parallel</a><a id="Run-MendelImpute-in-parallel-1"></a><a class="docs-heading-anchor-permalink" href="#Run-MendelImpute-in-parallel" title="Permalink"></a></h2><p>If Julia is started with multiple threads (e.g. <code>julia --threads 4</code>), MendelImpute.jl will automatically run your code in parallel.</p><ol><li><a href="https://docs.julialang.org/en/v1/manual/multi-threading/#Starting-Julia-with-multiple-threads">How to start Julia with multiple threads</a>.</li><li>Execute <code>Threads.nthreads()</code> within Julia to check if multiple thread is enabled</li><li>Set the number of BLAS threads to be 1 by <code>using LinearAlgebra; BLAS.set_num_threads(1)</code>. This avoids <a href="https://ieeexplore.ieee.org/document/5470434">oversubscription</a>. </li></ol><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>We recommend number of threads equal to the number of physical CPU cores on your machine. <strong>Number of Julia threads should never exceed number of physical CPU cores!!</strong> Hyperthreading is valuable for I/O operations (in our experience), but not for linear algebra routines used throughout MendelImpute. </p></div></div><h2 id="Compressing-haplotype-panels-is-slow"><a class="docs-heading-anchor" href="#Compressing-haplotype-panels-is-slow">Compressing haplotype panels is slow</a><a id="Compressing-haplotype-panels-is-slow-1"></a><a class="docs-heading-anchor-permalink" href="#Compressing-haplotype-panels-is-slow" title="Permalink"></a></h2><p>Currently it is recommended to build a new compressed reference haplotype panel for every new set of typed SNPs (although this is not strictly required). The compression routine is slow because reading raw VCF files is slow. Thus, it is highly advised that one try to use the same set of typed SNPs as much as possible. </p><p>We are actively developing a new set of functions in <a href="https://github.com/OpenMendel/SnpArrays.jl">SnpArrays.jl</a> to alleviate this problem. Since SnpArrays use memory mapping, read times can be improved dramatically. </p><h2 id="max_d-too-high-(or-too-low)"><a class="docs-heading-anchor" href="#max_d-too-high-(or-too-low)"><code>max_d</code> too high (or too low)</a><a id="max_d-too-high-(or-too-low)-1"></a><a class="docs-heading-anchor-permalink" href="#max_d-too-high-(or-too-low)" title="Permalink"></a></h2><p>When you compress the haplotype panels into a <code>.jlso</code> format, you specified <code>max_d</code> which is the maximum number of unique haplotypes per window. We generally recommend using <code>max_d = 1000</code>, BUT 1000 may be too small if you use a reference panel larger than HRC. In that case, you can try larger <code>max_d</code>, which will improve error rate. </p><h3 id="Symptoms-for-max_d-too-high:"><a class="docs-heading-anchor" href="#Symptoms-for-max_d-too-high:">Symptoms for <code>max_d</code> too high:</a><a id="Symptoms-for-max_d-too-high:-1"></a><a class="docs-heading-anchor-permalink" href="#Symptoms-for-max_d-too-high:" title="Permalink"></a></h3><p><code>Computing optimal haplotypes</code> is too slow. In particular, the timing for <code>haplopair search</code> is too high. </p><h3 id="Symptoms-for-max_d-too-low:"><a class="docs-heading-anchor" href="#Symptoms-for-max_d-too-low:">Symptoms for <code>max_d</code> too low:</a><a id="Symptoms-for-max_d-too-low:-1"></a><a class="docs-heading-anchor-permalink" href="#Symptoms-for-max_d-too-low:" title="Permalink"></a></h3><p>Too few typed SNPs per window indicates <code>max_d</code> is set too low. You can calculate the number of typed SNPs per window by dividing the total number of SNPs in the target file by the total windows (a number that will be output after every run). Ideally you want an average of 400 typed SNPs per window, but something as low as 50 still works. Something like 10~20 is too low. </p><h3 id="I-really-want-to-use-a-high-max_d"><a class="docs-heading-anchor" href="#I-really-want-to-use-a-high-max_d">I really want to use a high <code>max_d</code></a><a id="I-really-want-to-use-a-high-max_d-1"></a><a class="docs-heading-anchor-permalink" href="#I-really-want-to-use-a-high-max_d" title="Permalink"></a></h3><p>A high <code>max_d</code> generally improve error, so it is understandable you want to do so. If a high <code>max_d</code> value runs too slow, try setting <code>stepwise = 100</code> and <code>max_haplotypes</code> to a number that is close to 1000. This avoids searching the global minimizer of the least-squares problem for windows that have more than <code>max_haplotypes</code> number of unique haplotypes. Setting <code>thinning_factor</code> instead of <code>stepwise</code> have a similar effect. Details for these 2 heuristic searches are explained in the appendix of our paper. </p><h2 id="Do-you-have-enough-memory-(RAM)?"><a class="docs-heading-anchor" href="#Do-you-have-enough-memory-(RAM)?">Do you have enough memory (RAM)?</a><a id="Do-you-have-enough-memory-(RAM)?-1"></a><a class="docs-heading-anchor-permalink" href="#Do-you-have-enough-memory-(RAM)?" title="Permalink"></a></h2><p>While MendelImpute uses the least RAM compared to competing softwares (as of 2020), it is still possible for large imputation problems to consume all available RAM. If this happens, Julia will first try to use <code>swap</code> before crashing (until all of <code>swap</code> is consumed). Monitor your RAM usage constantly to make sure this doesn&#39;t happen. On Mac/Linux machines, the <code>top</code> or <code>htop</code> command will monitor this information. Alternatively, the <code>/usr/bin/time</code> command will automatically records max RAM usage for job and whether any <code>swap</code> had been performed. </p><h3 id="Rough-estimate-for-amount-of-RAM-needed"><a class="docs-heading-anchor" href="#Rough-estimate-for-amount-of-RAM-needed">Rough estimate for amount of RAM needed</a><a id="Rough-estimate-for-amount-of-RAM-needed-1"></a><a class="docs-heading-anchor-permalink" href="#Rough-estimate-for-amount-of-RAM-needed" title="Permalink"></a></h3><p>There are 4 things that require lots of memory:</p><ul><li>The target genotype matrix <span>$\mathbf{X}_{n \times p}$</span> requires <span>$n \times p \times 8$</span> bits. If <span>$\mathbf{X}$</span> is dosage data, then you need instead <span>$n \times p \times 32$</span> bits</li><li>The matrix <span>$\mathbf{M}_{d \times d}$</span> requires <span>$c \times d \times d \times 32$</span> bits, where <span>$c$</span> is the number of parallel threads used and <span>$d$</span> is the number specified in the <a href="https://openmendel.github.io/MendelImpute.jl/dev/man/api/#MendelImpute.compress_haplotypes">compress_haplotypes</a> function.</li><li>The matrix <span>$\mathbf{N}_{n \times d}$</span> requires <span>$c \times n \times d \times 32$</span> bits, where <span>$c$</span> is the number of parallel threads used and <span>$d$</span> is the number specified in the <a href="https://openmendel.github.io/MendelImpute.jl/dev/man/api/#MendelImpute.compress_haplotypes">compress_haplotypes</a> function.</li><li>The compressed reference haplotype panel produced by the <a href="https://openmendel.github.io/MendelImpute.jl/dev/man/api/#MendelImpute.compress_haplotypes">compress_haplotypes</a> function. This typically requires about <span>$3r$</span> gigabytes of RAM where <span>$r$</span> is your panel&#39;s size in <code>.vcf.gz</code>. </li></ul><p>If you do not have the above issues and your code is still running slow, file an issue on GitHub and we will take a look at it ASAP. </p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Phasing_and_Imputation/">« Phasing and Imputation</a><a class="docs-footer-nextpage" href="../painting/">Estimating ancestry »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Monday 6 February 2023 02:32">Monday 6 February 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
